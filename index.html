<!-- AI was utilised for grammer and debugging purposes -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Australia on Caffeine — an infographic ☕</title>

  <!-- Vega libs -->
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    /* ---------------- Theme ---------------- */
    :root{
      --espresso:#4a2c2a; --mocha:#7a4b3a; --caramel:#b07d62; --latte:#d7b98e;
      --crema:#f6efe7; --foam:#fff7e9; --ink:#2d1e19; --bean:#8c4c3a; --paper:#fff;
    }
    *{ box-sizing:border-box }
    html,body{ margin:0; padding:0; background:linear-gradient(180deg,var(--crema),var(--foam)); color:var(--ink) }
    body{ font-family:Inter,system-ui,Arial,Helvetica,sans-serif; line-height:1.5 }
    .wrap{ max-width:1400px; margin:0 auto; padding:18px 18px 56px }

    /* ---------- HERO ---------- */
    .hero{
      text-align:center; padding: 26px 8px 24px; margin-bottom: 8px;
      background: radial-gradient(1200px 240px at 50% 0%, rgba(122,75,58,.09), transparent 60%);
      border-radius: 18px;
      width:85%; margin-left:auto; margin-right:auto;
    }
    .hero h1{
      font-family:"Playfair Display",serif; color:var(--espresso); margin:8px 0 10px;
      font-size: clamp(34px,5vw,56px); letter-spacing:.2px
    }
    .hero .sub{ margin:0 auto; max-width:920px; color:var(--mocha); font-size: clamp(15px,1.6vw,18px) }

    /* ---------- SECTION BOXES ---------- */
    .section{
      position:relative; /* for the section title chip */
      width:100%; margin:24px auto;
      background:var(--paper); border:1px solid rgba(74,44,42,.08); border-radius:16px;
      box-shadow:0 10px 26px rgba(42,20,10,.06), inset 0 1px 0 rgba(255,255,255,.7);
      padding:28px 18px 18px;
    }

    /* Floating section title chip */
    .section-title{
      position:absolute; top:-14px; left:14px;
      background:#fff7e9; color:#7a4b3a;
      border:1px solid rgba(122,75,58,.25);
      padding:6px 12px; border-radius:999px;
      font: 800 11px/1 Inter, system-ui, Arial, sans-serif;
      letter-spacing:.14em; text-transform:uppercase;
      box-shadow:0 6px 14px rgba(42,20,10,.08);
      user-select:none;
    }

    .section-header{
      display:flex; align-items:baseline; gap:12px; margin: 2px 2px 14px;
      border-bottom:1px dashed rgba(74,44,42,.15); padding-bottom:8px
    }
    .kicker{ color:var(--latte); font-weight:800; letter-spacing:.14em; text-transform:uppercase; font-size:12px }
    h2{ color:var(--espresso); margin:0; font-size: clamp(20px,2.5vw,26px) }
    .lede{ color:var(--mocha); margin:8px 0 0 }

    /* ---------- GRID ---------- */
    .grid{ display:grid; gap:18px; align-items:start; grid-template-columns: minmax(0, 1.15fr) minmax(0, .95fr) }
    .grid.reverse{ grid-template-columns: minmax(0,.95fr) minmax(0,1.15fr) }
    .viz-col, .text-col{ min-width:0 }

    /* ---------- STATS TILES ---------- */
    .tiles{ display:grid; gap:14px; grid-template-columns: repeat(4, minmax(0,1fr)) }
    .tile{
      background:linear-gradient(180deg,#fff, #fffaf3);
      border:1px solid rgba(74,44,42,.08); border-radius:14px; padding:14px 12px;
      box-shadow: 0 8px 18px rgba(42,20,10,.06)
    }
    .tile .num{ color:var(--espresso); font-weight:800; font-size: clamp(22px,3.2vw,30px) }
    .tile .cap{ color:var(--mocha); font-size:13px }

    /* ---------- CHART CONTAINERS ---------- */
    .chart-card{
      background:#fff; border:1px solid rgba(74,44,42,.06); border-radius:14px;
      padding:10px; overflow:visible;
      z-index:1; position:relative; /* establish stacking context */
    }
    .vis{ width:100%; min-height:360px }
    .vis canvas{ position:relative; z-index:1; }

    /* Donut trio */
    #donuts .donut-row{ display:grid; gap:16px; grid-template-columns: repeat(3, minmax(0,1fr)) }
    #donuts .vis{ min-height:280px }

    /* Big map */
    .section.map-big{ width:95%; }
    .map-big .vis{ min-height:800px } /* bigger map height */

    /* Donut section layout: grid with legend column */
    #donuts .donut-layout{
      display: grid;
      grid-template-columns: 1fr 220px;   /* donuts | legend */
      gap: 16px;
      align-items: start;
    }
    #donuts .legend-box{
      background: #fff;
      border: 1px solid rgba(74,44,42,.10);
      border-radius: 10px;
      padding: 8px 10px;
      box-shadow: 0 8px 18px rgba(42,20,10,.06);
      min-width: 200px;
    }
    #donuts .legend-title{
      font: 700 11px/1 Inter, system-ui, Arial, sans-serif;
      color: #7a4b3a;
      letter-spacing: .06em;
      text-transform: uppercase;
      margin: 0 0 6px 0;
    }
    #donuts .vis{ min-height: 260px }

    /* ---------- WHO DRINKS (pie + HTML fact squares) ---------- */
    #who-pie .layout{
      display:grid;
      grid-template-columns: minmax(0, .9fr) minmax(0, 1.1fr);
      gap: 24px;
      align-items: center;
    }

    #who-pie .prose{
      max-width: 58ch;
      color: var(--mocha);
    }

    #who-pie .prose h3{
      margin: 0 0 8px; color: var(--espresso); font-size: 20px;
    }

    #who-pie .prose p{ margin: 6px 0 0 }

    /* Keep squares ABOVE the pie chart */
    #who-pie .chart-card{ position: relative; overflow: visible; }
    #who-pie .pie-wrap{ position: relative; width: 100%; max-width: 1100px; margin: 0 auto; aspect-ratio: 2/1; display: grid; place-items: center; }
    #who-pie .pie-center{ width:min(52vmin,520px); min-width:320px; aspect-ratio:1/1; display:grid; place-items:center; position: relative; z-index: 1; }

    /* Mobile */
    @media (max-width: 900px){
      #who-pie .layout{ grid-template-columns: 1fr; }
      #who-pie .pie-wrap{ margin-top: 8px; }
    }

    .fact-sq{
      position:absolute; width:112px; height:112px; padding:10px;
      background:#f3e3d6; border:1px solid rgba(74,44,42,.18); border-radius:12px;
      box-shadow: 0 10px 20px rgba(42,20,10,.08);
      display:flex; flex-direction:column; justify-content:center; align-items:center;
      text-align:center; gap:6px;
      z-index:5;           /* ABOVE the pie */
      pointer-events:none; /* ensure charts remain interactive */
    }
    .fact-sq .pct{ font-weight:800; color:#4a2c2a; font-size:18px; line-height:1 }
    .fact-sq .cap{ font-size:12px; color:#7a4b3a }

    /* Push the fact squares farther from the donut */
    .fs1{ top:2%;   left:0%;   rotate:-2deg; }
    .fs2{ top:6%;   right:0%;  rotate: 3deg; }
    .fs3{ bottom:8%; left:0%;  rotate: 2deg; }
    .fs4{ bottom:4%; right: 0%; rotate:-3deg; }
    .fs5{ top:35%;  left: 4%;  rotate:-4deg; }

    /* Ensure the chart (SVG/canvas) stays below the squares */
    #who-pie .pie-center .vis svg,
    #who-pie .pie-center .vis canvas {
      position: relative;
      z-index: 0;
    }

    @media (max-width: 900px){
      #who-pie .pie-center{ width:min(52vmin,520px); }
    }

    /* ---------- WHO DRINKS (bars + text) ---------- */
    #who-bars .grid{ grid-template-columns: .95fr 1.05fr }
    #who-bars .text-col{ align-self:center }

    /* Responsive */
    @media (max-width: 1100px){
      #donuts .donut-layout{ grid-template-columns: 1fr }
      #donuts .legend-box{ margin-top: 8px }
    }
    @media (max-width: 900px){
      #donuts .donut-row{ grid-template-columns: 1fr }
      .tiles{ grid-template-columns: 1fr 1fr }
      .grid, .grid.reverse{ grid-template-columns: 1fr }
      .fact-sq{ width:100px; height:100px }
    }

    /* Hide Vega action buttons */
    .vega-actions{ display:none !important }

    /* ---- References box ---- */
    .refs .ref-list{
      list-style: none; padding: 0; margin: 6px 0 6px;
      display: grid; gap: 8px; grid-template-columns: 1fr 1fr;
    }
    .refs .ref-list li{
      background: #fff; border: 1px solid rgba(74,44,42,.08);
      border-radius: 10px; padding: 10px 12px;
    }
    .refs .ref-list a{ color: var(--espresso); text-decoration: none; font-weight: 600; }
    .refs .ref-list a:hover{ text-decoration: underline }
    .refs .meta{
      display: inline-block; margin-left: 8px; font-size: 12px;
      color: var(--mocha); background: #fff7e9; border-radius: 999px;
      padding: 2px 8px;
    }
    .refs .refs-note{ margin-top: 12px; color: var(--mocha); font-size: 13px; }
    @media (max-width: 900px){ .refs .ref-list{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- HERO -->
    <header class="hero">
      <h1>Australia on Caffeine ☕</h1>
      <p class="sub">
Australia’s coffee culture is fiercely independent, craft-minded, and obsessed with quality. This infographic follows the journey behind every cup: what we drink, who drinks it, how habits are shifting, and the trade, places, and people that keep the nation caffeinated.
      </p>
    </header>

    <h1>Key Stats _________________________________________________________________________________________</h1>
    <!-- KEY STATS -->
    <section class="section">
      <span class="section-title">At a glance</span>
      <div class="section-header">
        <div class="kicker">At a glance</div><h2>The state of coffee in Australia</h2>
      </div>
      <div class="tiles">
        <div class="tile"><div class="num">2.2M</div><div class="cap">60-kg bags consumed per year</div></div>
        <div class="tile"><div class="num">2.1 kg</div><div class="cap">per person (2021)</div></div>
        <div class="tile"><div class="num">61.5%</div><div class="cap">adults drink coffee (ABS 2023)</div></div>
        <div class="tile"><div class="num">65%</div><div class="cap">have a machine at home</div></div>
      </div>
    </section>

    <h1>Top Coffee's In Australia _________________________________________________________________________________________</h1>

    <!-- WHAT’S IN A CUP -->
    <section class="section" id="donuts">
      <span class="section-title">What’s in a cup</span>
      <div class="section-header">
        <h2>Flat White, Cappuccino, and Caffé Latté</h2>
      </div>
      <p style="text-align: center; margin-bottom: 40px;" class="lede">A quick peek inside Australia’s big three milk-espresso drinks. Labels appear only when there’s room.</p>

      <div class="donut-layout">
        <div class="donut-row">
          <div class="vis" id="donut-flat"></div>
          <div class="vis" id="donut-capp"></div>
          <div class="vis" id="donut-latte"></div>
        </div>

        <aside class="legend-box" aria-label="Legend for drink components">
          <div class="legend-title">Components</div>
          <div class="vis" id="donut-legend-viz"></div>
        </aside>
      </div>
    </section>

    <h1>Australian's Opinion on Coffee _________________________________________________________________________________________</h1>

    <!-- WHO DRINKS — PIE (text left + pie with fact squares right) -->
    <section class="section" id="who-pie">
      <span class="section-title">Who drinks</span>
      <div class="section-header">
        <h2>Which Gender Drinks More Tea?</h2>
      </div>

      <div class="layout">
        <!-- LEFT: text -->
        <div class="text-col">
          <div class="prose">
            <h3>The headline takeaway</h3>
            <p>Women report slightly higher coffee consumption than men in our sample. Espresso culture runs deep, with strong at-home habits and regular café visits.</p>
            <p class="lade"><strong>What to watch:</strong> younger demographics lean toward milk-based drinks; machine ownership and local roaster purchases keep rising.</p>
          </div>
        </div>

        <!-- RIGHT: pie + floating fact squares -->
        <div class="viz-col">
          <div class="chart-card" style="max-width:1100px;margin:0 auto;">
            <div class="pie-wrap" aria-label="Pie with surrounding facts">
              <!-- Light-brown HTML squares (sit above the pie) -->
              <div class="fact-sq fs1"><div class="pct">75%</div><div class="cap">have espresso weekly</div></div>
              <div class="fact-sq fs2"><div class="pct">34%</div><div class="cap">buy from local roasters</div></div>
              <div class="fact-sq fs3"><div class="pct">62%</div><div class="cap">own a coffee machine</div></div>
              <div class="fact-sq fs4"><div class="pct">29%</div><div class="cap">prefer cappuccino</div></div>
              <div class="fact-sq fs5"><div class="pct">18%</div><div class="cap">drink instant at home</div></div>

              <!-- Centered pie -->
              <div class="pie-center">
                <div class="vis" id="chart-gender-pie"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- WHO DRINKS — BARS with text (chart LEFT, text RIGHT) -->
    <section class="section" id="who-bars">
      <span class="section-title">Who drinks</span>

      <div class="grid">
        <!-- LEFT: bar chart -->
        <div class="viz-col">
          <div class="chart-card" aria-label="Vertical bars: dependence by generation">
            <div class="vis" id="coffee-bars"></div>
          </div>
        </div>

        <!-- RIGHT: updated text -->
        <div class="text-col">
          <p class="lede">
            <h3>The headline takeaway</h3><br>
            Coffee reliance is strongest among mid-career adults, with younger people reporting a looser attachment and older groups describing a steadier, more moderate habit. The pattern points to coffee as a daily “fuel” during the busiest work and family years.
          </p>

          <p class="lede">
            <strong>What to watch:</strong> As <strong>Gen&nbsp;Z</strong> moves further into full-time work, their dependence could climb;
            hybrid work and rising home-machine ownership may shift consumption from cafés to kitchens;
            cost-of-living pressures could nudge frequency down but increase “quality per cup.”
          </p>
        </div>
      </div>
    </section>

    <!-- FREQUENCY — how often people drink coffee -->
    <section class="section" id="frequency">
      <div class="section-header">
              <span class="section-title">Habits</span>
      <h2>How often Australian's drink coffee</h2>
      </div>
      <div class="chart-card">
        <div class="vis" id="chart-stacked"></div>
      </div>
      <div class="text-col">
      <div class="prose">
        <h3>The headline takeaway</h3>
        <p>Most Australians drink coffee regularly but not always daily: the bulk of respondents sit in the “a few times a week” and “about once a week” bands, with a smaller but meaningful group having coffee every day. Truly infrequent drinkers are a minority.</p>
        <p><strong>What to watch:</strong> shifts from weekly to daily habits as machines and pods spread at home; cost-of-living pressures nudging people from café purchases to home prep; and seasonality or working-from-home patterns that may move people between weekly and several-times-a-week segments.</p>
      </div>
    </div>
    </section>

    <h1>What The Beans Are Billing Us _________________________________________________________________________________________</h1>

    <!-- TRADE (alternating graph/text) -->
    <section class="section" id="trade-value">
      <span class="section-title">Trade</span>
      <div class="section-header">
        <h2>Who supplies our beans?</h2>
      </div>
      <div class="grid">
        <div class="viz-col">
          <div class="chart-card" aria-label="Bar chart for import value by partner">
            <div class="vis" id="trade"></div>
          </div>
        </div>
      <div class="text-col">
        <div class="prose">
          <h3>The headline takeaway</h3>
          <p>Brazil overwhelmingly leads Australia’s coffee imports, with Colombia a distant second. Most other partners contribute relatively small shares, underscoring how concentrated our supply is in a few Latin American origins.</p>
          <p><strong>What to watch:</strong> Weather shocks, currency moves, or logistics issues in Brazil could ripple through local prices. Any growth in imports from Vietnam or Papua New Guinea would signal diversification away from a single dominant supplier.</p>
        </div>
      </div>
      </div>
    </section>

    <section class="section" id="trade-cost">
      <span class="section-title">Trade</span>
      <div class="section-header">
        <h2>What do we pay per kilogram?</h2>
      </div>
      <div class="grid reverse">
      <div class="text-col">
        <div class="prose">
          <h3>The headline takeaway</h3>
          <p>Guatemala commands the highest unit cost per kilogram—consistent with smaller volumes of higher-quality or specialty beans—while India and Vietnam sit at the lower end, reflecting large-scale, cost-efficient supply.</p>
          <p><strong>What to watch:</strong> If premium sourcing expands, expect average unit costs to rise. Track shifts in price-per-kg alongside volumes to see whether the market is tilting toward quality/ethics or maintaining a value focus.</p>
        </div>
      </div>
        <div class="viz-col">
          <div class="chart-card" aria-label="Bar chart for unit cost by partner">
            <div class="vis" id="unitcost"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="section" id="trade-trend">
      <span class="section-title">Trade</span>
      <div class="section-header">
        <h2>Imports vs exports over time (Green Coffee/ Raw Unroasted Coffee)</h2>
      </div>
      <div class="grid">
        <div class="viz-col">
          <div class="chart-card" aria-label="Line chart of green-coffee trade by year (USD)">
            <select id="flowSelect" aria-label="Select trade flow" style="margin-bottom:8px">
              <option value="Import" selected>Import</option>
              <option value="Export">Export</option>
            </select>
            <div class="vis" id="ie-line"></div>
          </div>
        </div>
        <div class="text-col">
          <div class="prose">
            <h3>The headline takeaway</h3>
            <p>Australia is a clear net importer of green coffee: import values are many times larger and show a pandemic-era surge around 2021–22 before easing. Exports remain small and relatively stable, reflecting a niche role (specialty/small re-exports) rather than a major origin.</p>
            <p><strong>What to watch:</strong> currency swings (AUD/USD), Brazil/Colombia harvests, shipping costs, and domestic café demand—all of which move import values. On the export side, growth in local roasting and specialty re-exports could lift the line, but any rise will likely be incremental.</p>
          </div>
        </div>
      </div>
    </section>

    <h1>Where Australian's Find Their Coffee  _________________________________________________________________________________________</h1>

    <!-- TREEMAP -->
    <section class="section" id="stores-treemap">
      <span class="section-title">Places</span>
      <div class="section-header">
        <h2>Top coffee chains by locations</h2>
      </div>
      <div class="chart-card" aria-label="Treemap of top Australian coffee chains by store count">
        <div class="vis" id="treemap"></div>
      </div>
      <p class="lede" style="margin-top:12px;">This treemap illustrates the dominance of coffee chains in Australia based on their number of locations, not popularity or quality. McCafé's massive footprint is a direct result of its integration into the vast, pre-existing McDonald's network, making it the leader in convenience and accessibility. It's followed by well-established local franchise models like The Coffee Club and Gloria Jean's, which have a strong presence in shopping centres and communities.</p>
    </section>


    <!-- Center wrapper -->
    <div style="display:flex; justify-content:center; padding:8px 0;">
      <!-- ===== Tiny card: Independents dominate ===== -->
      <div aria-label="Independents market share" 
          style="
            --espresso:#4a2c2a; --mocha:#7a4b3a; --foam:#fff7e9;
            display:block; width: min(1060px, 100%); margin:0 auto; text-align:center;
            background:linear-gradient(180deg,#ffffff,#fffaf3);
            border:1px solid rgba(74,44,42,.12); border-radius:14px;
            box-shadow:0 10px 24px rgba(42,20,10,.08), inset 0 1px 0 rgba(255,255,255,.8);
            padding:12px 12px 10px; font-family:Inter,system-ui,Arial,sans-serif; color:var(--espresso);
          ">
        <span style="
            display:inline-block; margin:-4px 0 8px; padding:4px 8px;
            font:800 10px/1 Inter; letter-spacing:.14em; text-transform:uppercase;
            background:var(--foam); color:var(--mocha);
            border:1px solid rgba(122,75,58,.25); border-radius:999px;
          ">Places and Market Structure</span>

        <div style="font-weight:800; font-size:32px; line-height:1;">70%+</div>
        <div style="font-size:11px; color:var(--mocha); margin-top:4px;">
          of Australian cafés are <strong>independent</strong>
        </div>

        <hr style="border:none; height:1px; background:rgba(74,44,42,.08); margin:8px 0 6px;">

        <!-- ≤50 words -->
        <div style="font-size:11px; color:var(--mocha);">
          Independent cafés win because small sites are cheap to open, roaster partnerships lift quality, and regulars reward service and personality. Chains offer convenience, but independents own the “destination cup” and brunch traffic—keeping share above 70%.
        </div>
      </div>
    </div>




    <!-- MAP — wider & taller, legend on right -->
    <section class="section map-big" id="melb-map">
      <span class="section-title">Places</span>
      <div class="section-header">
        <h2>Where Melbourne’s cafés cluster</h2>
      </div>
      <div class="chart-card" aria-label="Map of Melbourne cafés by postcode" style="border:none; padding:0;">
        <div class="vis" id="vis"></div>
      </div>
      <p class="lede" style="margin-top:12px;">Melbourne’s café map reveals a single dominant cluster: the CBD (postcode 3000) with 870 venues. Commuter and tourist footfall, laneway culture, and dense offices and universities pack cafés into a compact grid. Nearby hubs—South Yarra, Richmond, Fitzroy—remain lively but smaller, lacking the CBD’s commercial gravity and all-day demand, nightlife vibrancy.</p>
    </section>

    <section class="section" id="habit-summary">  
            <div class="text-col">
          <div class="prose">
            <h3>An Overview</h3>
            <p>Australia’s coffee story is clear: a quality-first culture powered by independents, sustained by steady weekly habits, and supplied by a concentrated import base. Cafés cluster where people move, especially the CBD, while home coffee machines are becoming more common. Coffee ultimately plays an important role in Australia's Culture and its Economy.</p>

          </div>
        </div>
    </section>

    <!-- REFERENCES -->
    <section class="section refs" id="refs">
      <span class="section-title">References</span>
      <div class="section-header">
        <div class="kicker"></div><h2>References & datasets</h2>
      </div>

      

      <ul class="ref-list" aria-label="References and datasets used">
        <li><a href="https://wits.worldbank.org/trade/comtrade/en/country/AUS/year/2023/tradeflow/Imports/partner/ALL/product/090111" target="_blank" rel="noopener noreferrer">UN Comtrade – Coffee (090111) imports for Australia (2023)</a><span class="meta">Dataset</span></li>
        <li><a href="https://www.beanscenemag.com.au/how-many-australians-actually-drink-coffee/" target="_blank" rel="noopener noreferrer">ABS (via BeanScene): “How many Australians actually drink coffee?” (2025)</a><span class="meta">Article</span></li>
        <li><a href="https://www.foodstandards.gov.au/science-data/food-nutrient-databases/afcd/australian-food-composition-database-download-excel-files#food" target="_blank" rel="noopener noreferrer">FSANZ – Australian Food Composition Database</a><span class="meta">Reference</span></li>
        <li><a href="https://www.mordorintelligence.com/industry-reports/australia-coffee-market" target="_blank" rel="noopener noreferrer">Mordor Intelligence – Australia Coffee Market</a><span class="meta">Report</span></li>
        <li><a href="https://www.kaggle.com/datasets/waqi786/worldwide-coffee-habits-dataset/data?select=worldwide_coffee_habits.csv" target="_blank" rel="noopener noreferrer">Kaggle – Worldwide Coffee Habits</a><span class="meta">Dataset</span></li>
        <li><a href="https://www.kaggle.com/datasets/michals22/coffee-dataset?select=Coffee_importers_consumption.csv" target="_blank" rel="noopener noreferrer">Kaggle – Coffee economic indicators (ICO)</a><span class="meta">Dataset</span></li>
        <li><a href="https://gts.ai/dataset-download/coffee-consumption-insights-dataset/#wpcf7-f47097-o1" target="_blank" rel="noopener noreferrer">GTS – Coffee Consumption Insights</a><span class="meta">Dataset</span></li>
        <li><a href="https://www.vittoriacoffee.com/blogs/news/australian-coffee-types" target="_blank" rel="noopener noreferrer">Vittoria Coffee – Australian Coffee Types</a><span class="meta">Background</span></li>
        <li><a href="https://balancecoffee.co.uk/blogs/blog/global-coffee-consumption-statistics" target="_blank" rel="noopener noreferrer">Balance Coffee – Global Coffee Statistics</a><span class="meta">Reference</span></li>
        <li><a href="https://www.ibisworld.com/australia/industry/cafes-and-coffee-shops/2015/" target="_blank" rel="noopener noreferrer">IBISWorld – Cafés & Coffee Shops (AU)</a><span class="meta">Industry</span></li>
      </ul>

      <p class="refs-note">Notes: Data were cleaned and aggregated for clarity. Latest available periods shown unless stated.</p>
    </section>

    
  </div>

  <!-- =============== SCRIPTS =============== -->
  <script>
  (async () => {
    /* --------- Palette & global chart config --------- */
    const COFFEE_RANGE = ["#d9c8b5","#b89374","#925c3f","#6b341c","#491e0e","#2b1107","#0f0703"];
    const VL_THEME = {
      view:{ stroke:null, continuousHeight:300, continuousWidth:300 },
      axis:{ labelFont:"Inter", titleFont:"Inter", labelColor:"#4a2c2a", titleColor:"#4a2c2a" },
      legend:{ labelFont:"Inter", titleFont:"Inter" }
    };

    /* --------- Donuts with centered % (largest slice) --------- */
    const donutSpec = (drink, title) => ({
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      title: { text: title, anchor: "middle", offset: 6 },
      autosize: { type:"fit", contains:"padding" },
      width: "container", height: 260, background:"#ffffff",
      data: { url: "./ingredient.json" },
      transform: [
        { filter: `datum.drink === '${drink}'` },
        { joinaggregate: [{ op: "sum", field: "value", as: "total" }] },
        { calculate: "datum.value / datum.total", as: "share" },
        { calculate: "format(datum.share, '.0%')", as: "pctLabel" }
      ],
      layer: [
        {
          mark: { type: "arc", innerRadius: 78, cornerRadius: 6, padAngle: 0.02, tooltip: true },
          encoding: {
            theta: { field: "value", type: "quantitative" },
            color: { field: "part", type: "nominal", legend: null, scale: { range: COFFEE_RANGE.slice(2,7) } },
            tooltip: [
              { field: "part", title: "Component" },
              { field: "value", title: "Share", format: ".0f" },
              { field: "pctLabel", title: "Percent" }
            ]
          }
        },
        {
          transform: [
            { window: [{ op: "rank", as: "r" }], sort: [{ field: "share", order: "descending" }] },
            { filter: "datum.r === 1" },
            { calculate: "format(datum.share, '.0%')", as: "centerPct" }
          ],
          mark: { type: "text", fontSize: 18, fontWeight: "700", align: "center", baseline: "middle", fill: "#1d110e" },
          encoding: { radius: { value: 0 }, theta: { value: 0 }, text: { field: "centerPct" } }
        }
      ],
      config: VL_THEME
    });

    /* Shared column legend for donuts */
    const donutLegendSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      autosize: { type: "fit", contains: "padding" }, width: 180, height: 90,
      data: { url: "./ingredient.json" },
      transform: [
        { filter: "datum.drink === 'Flat White'" },
        { aggregate: [{ op: "max", field: "value", as: "v" }], groupby: ["part"] }
      ],
      layer: [
        { mark: { type: "point", shape: "circle", size: 160, filled: true },
          encoding: { y:{ field:"part", type:"nominal", axis:null }, x:{ value:0 }, color:{ field:"part", scale:{ range: COFFEE_RANGE.slice(2,7) }, legend:null } } },
        { mark: { type: "text", dx: 12, align: "left", baseline: "middle", font: "Inter", fontSize: 12 },
          encoding: { y:{ field:"part", type:"nominal", axis:null }, x:{ value: 10 }, text:{ field:"part" } } }
      ],
      config: { view: { stroke: null } }
    };

    await vegaEmbed('#donut-flat',  donutSpec('Flat White','Flat White'),  { actions:false });
    await vegaEmbed('#donut-capp',  donutSpec('Cappuccino','Cappuccino'), { actions:false });
    await vegaEmbed('#donut-latte', donutSpec('Caffé Latté','Caffé Latté'), { actions:false });
    await vegaEmbed('#donut-legend-viz', donutLegendSpec, { actions:false });

    /* --------- Trade (value) --------- */
    const tradeSpec = {
      $schema:"https://vega.github.io/schema/vega-lite/v5.json",
      autosize:{ type:"fit", contains:"padding" },
      width:"container", height:380,
      data:{ url:"./trade_data.csv" },
      params:[{ name:"sliderMin", value:0, bind:{ input:"range", min:0, max:120000, step:5000, name:"Min Trade Value (×1000 USD): " } }],
      transform:[
        { calculate:"toNumber(datum['Trade Value 1000USD'])", as:"TradeValue" },
        { calculate:"toNumber(datum['Quantity'])", as:"Quantity" },
        { filter:"isValid(datum.TradeValue) && isFinite(datum.TradeValue)" },
        { filter:"isValid(datum.Quantity) && isFinite(datum.Quantity)" },
        { filter:"datum.TradeValue >= sliderMin" }
      ],
      mark:{ type:"bar", cornerRadiusEnd:6, tooltip:true },
      encoding:{
        y:{ field:"Partner", type:"nominal", sort:"-x", title:"Partner Country" },
        x:{ field:"TradeValue", type:"quantitative", title:"Trade Value (×1000 USD)", axis:{ format:",.0f" } },
        color:{ value:"#7a4b3a" },
        tooltip:[
          { field:"Partner", title:"Partner" },
          { field:"TradeValue", title:"Trade Value (×1000 USD)", format:"," },
          { field:"Quantity", title:"Quantity (kg)", format:"," }
        ]
      },
      config: VL_THEME
    };

    /* --------- Unit cost --------- */
    const unitCostSpec = {
      $schema:"https://vega.github.io/schema/vega-lite/v5.json",
      autosize:{ type:"fit", contains:"padding" },
      width:"container", height:380,
      data:{ url:"./trade_data.csv" },
      params:[{ name:"sliderMin", value:0, bind:{ input:"range", min:0, max:120000, step:5000, name:"Min Trade Value (×1000 USD): " } }],
      transform:[
        { calculate:"toNumber(datum['Trade Value 1000USD'])", as:"TradeValueK" },
        { calculate:"toNumber(datum['Quantity'])", as:"Quantity" },
        { filter:"isValid(datum.TradeValueK) && isFinite(datum.TradeValueK)" },
        { filter:"isValid(datum.Quantity) && isFinite(datum.Quantity) && datum.Quantity > 0" },
        { filter:"datum.TradeValueK >= sliderMin" },
        { calculate:"(datum.TradeValueK * 1000) / datum.Quantity", as:"UnitCostUSDperKG" }
      ],
      mark:{ type:"bar", cornerRadiusEnd:6, tooltip:true },
      encoding:{
        y:{ field:"Partner", type:"nominal", sort:"-x", title:"Partner Country" },
        x:{ field:"UnitCostUSDperKG", type:"quantitative", title:"Unit Cost (USD/kg)", axis:{ format:".2f" } },
        color:{ value:"#b07d62" },
        tooltip:[
          { field:"Partner", title:"Partner" },
          { field:"UnitCostUSDperKG", title:"Unit Cost (USD/kg)", format:".2f" },
          { field:"TradeValueK", title:"Trade Value (×1000 USD)", format:"," },
          { field:"Quantity", title:"Quantity (kg)", format:"," }
        ]
      },
      config: VL_THEME
    };

    await vegaEmbed('#trade', tradeSpec, { actions:false });
    await vegaEmbed('#unitcost', unitCostSpec, { actions:false });

    /* --------- Gender pie --------- */
    const genderPie = async () => {
      let values;
      try { const res = await fetch('./gender.json', { cache:'no-store' }); if (!res.ok) throw new Error(); values = await res.json(); }
      catch { values = [{ Gender:"Women", Percent:52.3 }, { Gender:"Men", Percent:47.4 }]; }

      const container = document.querySelector('#chart-gender-pie');
      if (!container) return;
      const width = Math.max(370, Math.floor(container.getBoundingClientRect().width || 200));

      const spec = {
        $schema: "https://vega.github.io/schema/vega-lite/v5.json",
        autosize: { type:"none" }, width, height: 320,
        data: { values },
        transform: [
          { calculate:"toNumber(datum.Percent)", as:"Percent" },
          { joinaggregate:[{ op:"sum", field:"Percent", as:"Total" }] },
          { calculate:"datum.Percent / datum.Total", as:"Share" }
        ],
        layer: [
          { mark:{ type:"arc", outerRadius:140, stroke:"white" },
            encoding:{
              theta:{ field:"Percent", type:"quantitative" },
              color:{ field:"Gender", type:"nominal", title:null, scale:{ domain:["Women","Men"], range:["#6b341c","#b89374"] },
                      legend:{ orient:"bottom", direction:"horizontal" } },
              tooltip:[ { field:"Gender" }, { field:"Percent", type:"quantitative", format:".1f", title:"Percent" } ]
            }},
          { transform:[{ filter:"datum.Gender === 'Women'" }],
            mark:{ type:"text", fontSize:12, align:"center", baseline:"middle", dy:-80, dx:-44, fill:"#ffffff" },
            encoding:{ theta:{ field:"Percent" }, radius:{ value:92 }, text:{ field:"Gender" } } },
          { transform:[{ filter:"datum.Gender === 'Men'" }],
            mark:{ type:"text", fontSize:12, align:"center", baseline:"middle", dy:-26, dx:42, fill:"#1d110e" },
            encoding:{ theta:{ field:"Percent" }, radius:{ value:44 }, text:{ field:"Gender" } } }
        ],
        config: VL_THEME
      };

      container.innerHTML = "";
      await vegaEmbed("#chart-gender-pie", spec, { actions:false });
    };

/* --------- Coffee dependence (vertical bars) --------- */
const coffeeBars = async () => {
  let rows;
  try {
    const res = await fetch('./coffee_dependence.json', { cache:'no-store' });
    if (!res.ok) throw new Error();
    rows = await res.json();
  } catch {
    rows = [
      { Generation:"Gen Z", Percent:13 },
      { Generation:"Gen Y (Millennials)", Percent:29 },
      { Generation:"Gen X", Percent:31 },
      { Generation:"Baby Boomers", Percent:19 }
    ];
  }

  const container = document.querySelector('#coffee-bars');
  if (!container) return;
  const width = Math.max(520, Math.floor(container.getBoundingClientRect().width || 720));

  const spec = {
    $schema: "https://vega.github.io/schema/vega-lite/v5.json",

    // ✅ Reserve space for axes/titles
    autosize: { type: "fit", contains: "padding" },
    padding: { top: 8, right: 10, bottom: 48, left: 56 },

    width, height: 360,
    title: {
      text: "Coffee dependence by generation",
      subtitle: "Share who say they can’t get through the day without coffee",
      anchor: "start",
      font: "Inter",
      color: "#4a2c2a",
      subtitleColor: "#7a4b3a",
      fontSize: 18,
      subtitleFontSize: 13,
      offset: 8
    },
    data: { values: rows },
    transform: [
      { calculate: "toNumber(datum.Percent)", as: "Percent" },
      { calculate: "datum.Percent/100", as: "Rate" },
      { calculate: "datum.Percent + '%'", as: "Label" },
      { calculate: "'Coffee dependence'", as: "Series" }
    ],

    layer: [
      {
        mark: { type: "bar", cornerRadiusEnd: 6 },
        encoding: {
          x: {
            field: "Generation", type: "nominal",
            sort: ["Gen Z","Gen Y (Millennials)","Gen X","Baby Boomers"],
            axis: {
              title: "Generation",
              labelAngle: 0, titleFont: "Inter", labelFont: "Inter",
              titleColor: "#4a2c2a", titlePadding: 8
            }
          },
          y: {
            field: "Rate", type: "quantitative",
            axis: {
              title: "Share of respondents",
              format: ".0%",
              titleFont: "Inter", labelFont: "Inter",
              titleColor: "#4a2c2a", titlePadding: 8
            },
            scale: { domain: [0, 0.4] }
          },
          color: {
            field: "Series", type: "nominal",
            scale: { range: ["#7a4b3a"] },
            legend: { title: "", orient: "top", symbolType: "square", symbolSize: 120, labelFont: "Inter" }
          },
          tooltip: [
            { field: "Generation", type: "nominal", title: "Generation" },
            { field: "Percent", type: "quantitative", title: "Dependence", format: ".0f" }
          ]
        }
      },
      {
        mark: { type: "text", dy: -6, fontWeight: "bold", fill: "#1d110e" },
        encoding: {
          x: { field: "Generation", type: "nominal",
               sort: ["Gen Z","Gen Y (Millennials)","Gen X","Baby Boomers"] },
          y: { field: "Rate", type: "quantitative" },
          text: { field: "Label" }
        }
      }
    ],

    // Make sure layered axes remain shared and visible
    resolve: { axis: { x: "shared", y: "shared" } },

    config: {
      view: { stroke: null },
      axis: { labelFont: "Inter", titleFont: "Inter" },
      legend: {}
    }
  };

  container.innerHTML = "";
  await vegaEmbed("#coffee-bars", spec, { actions:false });
};

    await genderPie();
    await coffeeBars();

    /* --------- Import/Export line --------- */
    const ieLine = async () => {
      const spec = {
        $schema:"https://vega.github.io/schema/vega-lite/v5.json",
        description:"Green-coffee trade (USD) by year with Import/Export toggle.",
        autosize:{ type:"fit-x", contains:"padding" },
        width:"container", height:260,
        params:[ { name:"flow", value:"Import" } ],
        data:{ url:"./i_e_year.csv" },
        transform:[
          { filter:"datum.Flow === flow" },
          { calculate:"toNumber(datum['Trade (USD)'])", as:"TradeUSD" },
          { calculate:"toNumber(datum['Year'])", as:"YearNum" },
          { filter:"isValid(datum.TradeUSD) && isFinite(datum.TradeUSD) && isValid(datum.YearNum)" }
        ],
        mark:{ type:"line", point:{ filled:true, size:50 }, strokeWidth:2.4 },
        encoding:{
          x:{ field:"YearNum", type:"quantitative", title:"Year", axis:{ tickMinStep:1, format:"d", labelAngle:0 } },
          y:{ field:"TradeUSD", type:"quantitative", title:"Trade (USD)", axis:{ format:"$,.2s" } },
          color:{ value:"#7a4b3a" },
          tooltip:[ { field:"YearNum", title:"Year", format:"d" }, { field:"Flow" }, { field:"TradeUSD", title:"Trade (USD)", format:"$,.0f" } ],
          order:{ field:"YearNum" }
        },
        config: VL_THEME
      };

      const embedResult = await vegaEmbed("#ie-line", spec, { actions:false, renderer:"canvas" });
      const view = embedResult.view;
      const sel = document.getElementById("flowSelect");
      if (sel) {
        view.signal("flow", sel.value).run();
        sel.addEventListener("change", () => view.signal("flow", sel.value).run());
      }
    };
    await ieLine();

/* --------- Treemap (Vega) --------- */
const treemap = async () => {
  let rows = [];
  try {
    const res = await fetch('./stores.json', { cache:'no-store' });
    if (!res.ok) throw new Error(res.status);
    rows = await res.json();
  } catch { rows = []; }

  const container = document.getElementById('treemap');
  if (!container) return;
  const measuredWidth  = Math.max(600, Math.floor(container.getBoundingClientRect().width || 1000));
  const measuredHeight = 360;

  const tuples = [{ id:'root', parent:null, name:'All Chains', value:0 }].concat(
    rows.map(d => ({ id:String(d.name), parent:'root', name:String(d.name), value:Number(d.locations) }))
        .filter(d => Number.isFinite(d.value) && d.value > 0)
  );

  const spec = {
    $schema: "https://vega.github.io/schema/vega/v5.json",
    autosize: { type:"fit", contains:"padding", resize:true },
    width: measuredWidth, height: measuredHeight, padding: 6, background: "#ffffff",

    data: [
      {
        name: "table",
        values: tuples,
        transform: [
          { type:"stratify", key:"id", parentKey:"parent" },
          { type:"treemap",
            field:"value", method:"squarify",
            sort:{ field:"value", order:"descending" },
            round:true, ratio:1.2, size:[{ signal:"width" },{ signal:"height" }],
            as:["x0","y0","x1","y1","depth","children"]
          },
          { type:"filter", expr:"!datum.children" },
          { type:"formula", as:"w",    expr:"datum.x1 - datum.x0" },
          { type:"formula", as:"h",    expr:"datum.y1 - datum.y0" },
          { type:"formula", as:"area", expr:"datum.w * datum.h" }
        ]
      },
      // stats for dynamic label contrast (white on darker tiles)
      {
        name: "stats",
        source: "table",
        transform: [{ type:"aggregate", fields:["value"], ops:["median"], as:["med"] }]
      }
    ],

    // Map value -> shade so larger tiles are darker
    scales: [
      {
        name: "color",
        type: "linear",
        domain: { data:"table", field:"value" },
        range: ["#d9c8b5","#b89374","#925c3f","#6b341c","#491e0e"],
        nice: true
      }
    ],

    marks: [
      {
        type: "rect",
        from: { data: "table" },
        encode: {
          enter: {
            x:   { field:"x0" }, y:   { field:"y0" },
            x2:  { field:"x1" }, y2:  { field:"y1" },
            fill:{ scale:"color", field:"value" },
            stroke: { value:"#ffffff" }, strokeWidth: { value:0.8 },
            tooltip:{ signal:"{'Chain': datum.name, 'Locations': format(datum.value, ',')}" }
          }
        }
      },
      {
        type: "text",
        from: { data: "table" },
        encode: {
          enter: {
            align:   { value:"center" },
            baseline:{ value:"middle" },
            clip:    { value: true } // keep text inside the tile
          },
          update: {
            x:        { signal:"(datum.x0 + datum.x1)/2" },
            y:        { signal:"(datum.y0 + datum.y1)/2" },
            // Hide labels on very small tiles
            opacity:  { signal:"datum.area >= 900 ? 1 : 0" },
            // Auto-size text to fit; clamp to a nice range
            font:     { value:"Inter, system-ui, Arial" },
            fontSize: { signal:"clamp(min(datum.w, datum.h)/6, 10, 16)" },
            // Truncate so it never overhangs horizontally
            limit:    { signal:"max(datum.w - 8, 0)" },
            text:     { signal:"datum.name" },
            // White text on darker tiles (>= median value), black otherwise
            fill:     { signal:"datum.value >= data('stats')[0].med ? '#ffffff' : '#000000'" }
          }
        }
      }
    ]
  };

  await vegaEmbed("#treemap", spec, { actions:false });
};
await treemap();

/* --------- Frequency (normalized stacked bar) — FIXED SCALE --------- */
(async () => {
  let values = [
    { frequency: "Less than once a month", percent: 8 },
    { frequency: "Around once a month",    percent: 7 },
    { frequency: "A few times a month",    percent: 12 },
    { frequency: "About once a week",      percent: 23 },
    { frequency: "A few times a week",     percent: 39 },
    { frequency: "Every day",              percent: 11 }
  ];
  try {
    const res = await fetch('./stacked.json', { cache: 'no-store' });
    if (res.ok) values = await res.json();
  } catch {}

  const el = document.querySelector('#chart-stacked');
  if (!el) return;

  const ORDER = [
    "Less than once a month","Around once a month","A few times a month",
    "About once a week","A few times a week","Every day"
  ];
  const COFFEE_SOFT = ["#fff7e9","#f6efe7","#d7b98e","#b07d62","#7a4b3a","#4a2c2a"];

  const spec = {
    $schema: "https://vega.github.io/schema/vega-lite/v5.json",
    autosize: { type: "pad", contains: "padding" },
    width: 1300,
    height: 200,
    padding: { top: 8, right: 16, bottom: 70, left: 10 },

    title: {
      text: "Store and Home Coffee",
      subtitle: "Share of respondents by frequency (normalized to 100%)",
      anchor: "start",
      font: "Inter", color: "#4a2c2a",
      subtitleColor: "#7a4b3a",
      fontSize: 18, subtitleFontSize: 13, offset: 8
    },

    data: { values },

    transform: [
      { calculate: "toNumber(datum.percent)", as: "percent" },
      { calculate: "datum.percent/100", as: "rate" },           // <-- use 0–1 rate
      { calculate: "'All respondents'", as: "group" },
      { calculate: "datum.percent + '%'", as: "labelPercent" }
    ],

    layer: [
      {
        mark: { type: "bar" },
        encoding: {
          y: { field: "group", type: "nominal", axis: null },
          x: {
            field: "rate", type: "quantitative", stack: "normalize", // <-- rate everywhere
            title: "Share of respondents",
            axis: { format: ".0%" },                                  // shows 0–100%
            scale: { domain: [0, 1] }                                 // lock to 0–1
          },
          color: {
            field: "frequency", type: "nominal", sort: ORDER,
            scale: { domain: ORDER, range: COFFEE_SOFT },
            legend: {
              title: "Frequency", orient: "bottom", direction: "horizontal",
              columns: 3, labelFont: "Inter", titleFont: "Inter",
              symbolType: "square", symbolSize: 140
            }
          },
          tooltip: [
            { field: "frequency", title: "Frequency" },
            { field: "percent", title: "Percent %", format: ".0f" }
          ]
        }
      },
      
    ],

    config: {
      view: { stroke: null },
      axis: { labelFont: "Inter", titleFont: "Inter", labelColor: "#4a2c2a", titleColor: "#4a2c2a" },
      legend: { labelFont: "Inter", titleFont: "Inter" }
    }
  };

  el.innerHTML = "";
  await vegaEmbed("#chart-stacked", spec, { actions: false, renderer: "canvas" });
})();



    /* --------- Map --------- */
    const cafesMap = async () => {
      const [mapRes, dataRes] = await Promise.all([ fetch('./map.json'), fetch('./data.json') ]);
      if (!mapRes.ok || !dataRes.ok) return;

      const mapGeo = await mapRes.json();
      const poiGeo = await dataRes.json();

      const mapFeatures = (mapGeo && mapGeo.type === 'FeatureCollection' && Array.isArray(mapGeo.features)) ? mapGeo.features : [];
      const poiFeaturesRaw = (poiGeo && poiGeo.type === 'FeatureCollection' && Array.isArray(poiGeo.features)) ? poiGeo.features : [];

      const toTitle = (s) => String(s||'').toLowerCase().replace(/\b\w/g,c=>c.toUpperCase()).trim();
      const pcFrom = (p={})=>{
        const direct=p.postcode??p.post_code??p.Postcode??p.POSTCODE??p.pc??p.PC??null;
        if(direct!=null && /^\d{4}$/.test(String(direct))) return String(direct);
        const addr=p.business_address||p.address||p.Address||''; const m=String(addr).match(/\b\d{4}\b/); return m?m[0]:null;
      };
      const suburbFrom = (p={})=>{
        const direct=p.clue_small_area??p.suburb??p.Suburb??p.SUBURB??null; if(direct) return toTitle(direct);
        const addr=String(p.business_address||p.address||p.Address||'');
        let m=addr.match(/,\s*([A-Za-z \-']+)\s+VIC\b/i); if(m&&m[1]) return toTitle(m[1]);
        m=addr.match(/([A-Za-z \-']+)\s+\d{4}\b/); if(m&&m[1]) return toTitle(m[1]); return null;
      };

      const rowsPoi=[];
      for(const f of poiFeaturesRaw){
        const g=f?.geometry, p=f?.properties||{}; if(!g||g.type!=='Point'||!Array.isArray(g.coordinates)) continue;
        const cat=String(p.industry_anzsic4_description||'').trim().toLowerCase(); if(!cat.includes('cafes and restaurants')) continue;
        const [lon,lat]=g.coordinates; if(typeof lon!=='number'||typeof lat!=='number') continue;
        const pc=pcFrom(p); if(!pc) continue; const sub=suburbFrom(p);
        rowsPoi.push({pc,sub,lon,lat});
      }

      const byPc=new Map();
      for(const r of rowsPoi){
        if(!byPc.has(r.pc)) byPc.set(r.pc,{pc:r.pc,n:0,lonSum:0,latSum:0,subCounts:new Map()});
        const a=byPc.get(r.pc);
        a.n+=1; a.lonSum+=r.lon; a.latSum+=r.lat;
        const key=r.sub||`Postcode ${r.pc}`; a.subCounts.set(key,(a.subCounts.get(key)||0)+1);
      }

      const agg=[]; let maxN=0;
      for(const a of byPc.values()){
        let label=`Postcode ${a.pc}`, maxC=-1;
        for(const [k,c] of a.subCounts.entries()){ if(c>maxC){ maxC=c; label=k; } }
        const lon_mean=a.lonSum/a.n, lat_mean=a.latSum/a.n; maxN=Math.max(maxN,a.n);
        agg.push({pc:a.pc,label,n:a.n,lon_mean,lat_mean});
      }

      const mapSpec={
        $schema:"https://vega.github.io/schema/vega-lite/v5.json",
        autosize:{ type:"fit", contains:"padding" },
        width:"container", height:1000, background:"#ffffff",
        projection:{ type:"mercator", center:[144.96,-37.82], scale:500000 },
        layer:[
          { data:{ sphere:true }, mark:{ type:"geoshape", fill:"#fff7e9" } },
          { data:{ values:mapFeatures }, mark:{ type:"geoshape", fill:null, stroke:"#5b3a2e", strokeWidth:1 },
            encoding:{ shape:{ field:"geometry", type:"geojson" } } },
          { data:{ values:agg }, layer:[
            { mark:{ type:"circle", opacity:0.9, stroke:"#ffffff", strokeWidth:1, blend:"multiply" },
              encoding:{
                longitude:{ field:"lon_mean" }, latitude:{ field:"lat_mean" },
                size:{ field:"n", type:"quantitative", title:"Venues per postcode",
                       scale:{ type:"sqrt", domain:[1,Math.max(5,maxN)], range:[220,3200] } },
                color:{ field:"n", type:"quantitative", title:"Count", scale:{ range:COFFEE_RANGE, domain:[1,Math.max(5,maxN)] } },
                tooltip:[ { field:"pc", title:"Postcode" }, { field:"label", title:"Suburb (mode)" }, { field:"n", title:"Cafés/Restaurants" } ]
              }},
            { mark:{ type:"text", baseline:"middle", align:"center", fontSize:12, fontWeight:"bold", fill:"#ffffff" },
              encoding:{ longitude:{ field:"lon_mean" }, latitude:{ field:"lat_mean" }, text:{ field:"n" } } }
          ]}
        ],
        config: VL_THEME
      };

      await vegaEmbed('#vis', mapSpec, { actions:false });
    };
    await cafesMap();

    /* --------- Section reveal on scroll (flow) --------- */
    const io = ('IntersectionObserver' in window)
      ? new IntersectionObserver(entries => {
          for (const e of entries) if (e.isIntersecting) e.target.classList.add('in');
        }, { threshold: 0.1 })
      : null;

    document.querySelectorAll('.section').forEach(s => { if (io) io.observe(s); else s.classList.add('in'); });

  })();
  </script>
</body>
</html>
